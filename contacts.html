<!DOCTYPE html>
<html>
  <head>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="skeleton.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://dl.frontapp.com/libs/frontjs.min.js"></script>
    <script type="text/javascript" src="test-plugin.js"></script>
    <style>
      h2 {
        text-align: center;
      }
      #signout-button, #authorize-button {
        margin: auto;
      }
      p {
        margin: 10px;
        text-align: center;
      }
      #refresh {
        border: none;
        text-transform: none;
        font-size: 1em;
      }
      .centered-div {
        text-align: center;
      }
      #scrollbox {
        white-space: pre-wrap;
        max-height: 200px;
        width: 50%;
        overflow: scroll;
        margin: auto;
      }
    </style>

    <script>
      // calendar picker
      $( function() {
        $( "#datepicker" ).datepicker();
      } );
    </script>

  </head>
  <body>
    <h2>Contact Information</h2>

    <div class="centered-div"><button id="refresh" onclick="return false">&#8634; Refresh</button></div>

    <div id="output"></div>

    <pre id="content"></pre>

    <!--Add buttons to initiate auth sequence and sign out-->
    <br><br>
    <button id="authorize-button" style="display: none;">Authorize</button>
    <button id="signout-button" style="display: none;">Sign Out</button>


    <script type="text/javascript">
      // Client ID and API key from the Developer Console
      // var CLIENT_ID = '590936402413-hr4uj4vasgeirpc507ehr3s4k3nchh9b.apps.googleusercontent.com';
      var CLIENT_ID = '590936402413-rb20t115uvqn90tai3174gh6pp4ncc0t.apps.googleusercontent.com';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      var authorizeButton = document.getElementById('authorize-button');
      var signoutButton = document.getElementById('signout-button');

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
          clientId: CLIENT_ID,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          collectContactInfo();
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }


      contactInfo = {}
      contactInfo2 = {}
      past_reservations = {}
      future_reservations = {}
      console.log(past_reservations)
      
      function display(array, array2) {
        var part1 = "<p>Email: " + array[0] + "<br>Phone: " + array[1] + "<br>Restaurant: " + array[2] + "</p><p>Profile: </p><div id='scrollbox'>" + array[3] + "</div><p>Requests: " + array2[0] + "<br>Request frequency: " + array2[1] + "<br>Success rate: " + array2[2] + "</p>"

        var part2 = "<p>Past reservations: </p><div id='scrollbox'><br>"
        for (var i = 0; i < past_reservations[array[2]].length; i++) {
          part2 += "" + past_reservations[array[2]][i] + "<br>"
        };
        part2 += "</div>"

        var part3 = "<p>Future reservations: </p><div id='scrollbox'><br>"

        if (future_reservations.length > 0) {
          for (var i = 0; i < future_reservations[array[2]].length; i++) {
            part3 += "" + future_reservations[array[2]][i] + "<br>"
          };
        };

        part3 += "</div>"

        $('#output').html(part1 + part2 + part3)
      }

      function frontOn() {
        name = 'Mo Koyfman'
        display(contactInfo[name], contactInfo2[name])
      }

      function collectContactInfo() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '12FB3gJRZRk0Pp9aZTZxNu3N49xdrabDNg-pwJjCI638',
          range: 'Master Contact',
        }).then(function(response) {
          var range = response.result;
          for (var i = 2; i < range.values.length; i++) {
            contactInfo[range.values[i][0]] = [range.values[i][7], range.values[i][8], range.values[i][4], range.values[i][23]]
          };
        }, function(response) {
          console.log('Error: ' + response.result.error.message);
        }); 

        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '12FB3gJRZRk0Pp9aZTZxNu3N49xdrabDNg-pwJjCI638',
          range: 'FAQs by Members',
        }).then(function(response) {
          var range = response.result;

          for (var i = 2; i < range.values.length; i++) {
            contactInfo2[range.values[i][0]] = [range.values[i][5], range.values[i][7], range.values[i][13]]
          };

        }, function(response) {
          console.log('Error: ' + response.result.error.message);
        });

        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1CYJxaWG77ul918c1xEjlGdslHM4ataRcvh1hD8M_cP8',
          range: 'RESERVATIONS',
        }).then(function(response) {
          var range = response.result;

          for (var i = 2; i < range.values.length; i++) {

            var date = range.values[i][0]
            var datepart1 = date.split(", ")[1]
            var datepart2 = date.split(", ")[2].split(" at")[0]
            var date = datepart1 + ", " + datepart2

            if (new Date() > new Date(date)) {
              past_reservations[range.values[i][2]] = []
            }
            else {
              future_reservations[range.values[i][2]] = []
            };
          };

          for (var i = 2; i < range.values.length; i++) {

            var date = range.values[i][0]
            var datepart1 = date.split(", ")[1]
            var datepart2 = date.split(", ")[2].split(" at")[0]
            var date = datepart1 + ", " + datepart2

            var difference = new Date() - new Date(date)
            var difference = Math.floor(difference/1000/60/60/24);

            if (difference < 60) {
              if (new Date() > new Date(date)) {
                past_reservations[range.values[i][2]].push(i+1) //location in document
                past_reservations[range.values[i][2]].push(range.values[i][2])
                past_reservations[range.values[i][2]].push(range.values[i][0])
                past_reservations[range.values[i][2]].push(range.values[i][4])
                past_reservations[range.values[i][2]].push(range.values[i][11])
                past_reservations[range.values[i][2]].push(range.values[i][14])
                past_reservations[range.values[i][2]].push(range.values[i][12])
              }
              else {
                future_reservations[range.values[i][2]].push(i+1) //location in document
                future_reservations[range.values[i][2]].push(range.values[i][2])
                future_reservations[range.values[i][2]].push(range.values[i][0])
                future_reservations[range.values[i][2]].push(range.values[i][4])
                future_reservations[range.values[i][2]].push(range.values[i][11])
                future_reservations[range.values[i][2]].push(range.values[i][14])
                future_reservations[range.values[i][2]].push(range.values[i][12])
              };
            };
          };

        }, function(response) {
          console.log('Error: ' + response.result.error.message);
        });
      }

      // Front.on('conversation', function (data) {
      //     // name = data.contact.display_name
      //     name = 'Daniel Vidolov'
          // frontOn();
      // });

      // $('#refresh').click(function() { collectContactInfo() });
      $('#refresh').click(function() { frontOn() });

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>